# Not_bot - Бот-напоминатель о приеме лекарств

## Описание проекта

Not_bot - это Telegram-бот, разработанный для помощи пользователям в отслеживании приема лекарств и получения полезной ежедневной информации. Бот отправляет напоминания о необходимости принять лекарства в соответствии с установленным расписанием, а также предоставляет ежедневные сводки с полезной информацией.

## Основные функции

### Управление лекарствами

1. **Добавление лекарств** - пользователи могут добавлять информацию о своих лекарствах, включая:
   - Название лекарства
   - Дозировку (количество капсул/таблеток за один прием)
   - Количество приемов в день
   - Дату начала приема
   - Длительность курса (в днях или месяцах)
   - Длительность перерыва между курсами (в днях или месяцах)
   - Количество курсов

2. **Просмотр списка лекарств** - пользователи могут просматривать список всех добавленных лекарств с информацией о:
   - Текущем статусе (активно/перерыв)
   - Оставшемся времени до окончания курса или перерыва
   - Дозировке и режиме приема

3. **Редактирование лекарств** - возможность изменить любые параметры добавленного лекарства

4. **Удаление лекарств** - возможность удалить лекарство из списка

### Система уведомлений

1. **Напоминания о приеме лекарств** - бот отправляет уведомления в соответствии с установленным расписанием приема лекарств

2. **Ежедневные сводки** - каждое утро бот отправляет сводку, содержащую:
   - Прогноз погоды для Москвы и Бреста
   - Текущие курсы валют (USD/RUB, BTC, ETH, TON)
   - Персональный гороскоп (на основе знака зодиака пользователя)
   - Мотивационную цитату дня

3. **Настройка уведомлений** - пользователи могут:
   - Указать свой знак зодиака для получения персонального гороскопа
   - Включать/выключать уведомления
   - Устанавливать время получения ежедневных сводок

## Техническая реализация

### Архитектура проекта

Проект имеет модульную структуру и состоит из следующих основных компонентов:

1. **Ядро (core)**
   - `database.py` - модуль для работы с SQLite базой данных
   - `logger.py` - настройка логирования

2. **Модели данных (models)**
   - `medication.py` - модель для представления данных о лекарствах
   - `user.py` - модель для представления данных о пользователях

3. **Обработчики команд (handlers)**
   - `medication_handlers.py` - обработчики команд для управления лекарствами
   - `notification_handlers.py` - обработчики команд для управления уведомлениями

4. **Сервисы (services)**
   - `notification_service.py` - сервис для отправки уведомлений пользователям
   - `scheduler_service.py` - сервис для планирования и выполнения задач по расписанию

5. **Утилиты (utils)**
   - `helpers.py` - вспомогательные функции для расчета времени уведомлений и форматирования информации
   - `services.py` - сервисы для получения внешних данных (погода, курсы валют, гороскоп)
   - `validators.py` - функции для валидации пользовательского ввода

### База данных

Проект использует SQLite для хранения данных о:
- Пользователях и их настройках (знак зодиака)
- Лекарствах и их параметрах

Структура базы данных:
1. Таблица `medications`:
   - `id` - уникальный идентификатор лекарства
   - `user_id` - идентификатор пользователя
   - `name` - название лекарства
   - `dose_per_intake` - доза за один прием
   - `intakes_per_day` - количество приемов в день
   - `start_date` - дата начала приема
   - `duration_value` - значение длительности приема
   - `duration_unit` - единица измерения длительности (days/months)
   - `break_value` - значение длительности перерыва
   - `break_unit` - единица измерения перерыва (days/months)
   - `cycles` - количество курсов

2. Таблица `user_settings`:
   - `user_id` - идентификатор пользователя
   - `zodiac_sign` - знак зодиака пользователя

### Внешние API

Бот взаимодействует со следующими внешними API:
- OpenWeatherMap API - для получения прогноза погоды
- ExchangeRate API - для получения курсов валют (фиат)
- CryptoCompare API - для получения курсов криптовалют
- Парсинг сайта horo.mail.ru - для получения гороскопов

### Планировщик задач

Для работы с расписаниями и отложенными задачами используется библиотека APScheduler (AsyncIOScheduler), которая позволяет:
- Отправлять ежедневные утренние сводки в 8:00
- Проверять необходимость отправки напоминаний о приеме лекарств каждые 30 минут

Расписание приема лекарств рассчитывается автоматически в зависимости от количества приемов в день:
- 1 прием: 9:00
- 2 приема: 9:00, 21:00
- 3 приема: 9:00, 15:00, 21:00
- 4 приема: 8:00, 11:00, 14:00, 17:00
- 6 приемов: 8:00, 10:00, 12:00, 14:00, 16:00, 18:00

## Особенности реализации

1. **Асинхронность** - бот использует асинхронные обработчики для эффективной работы с Telegram API

2. **Конечные автоматы** - для многошаговых диалогов (например, добавление лекарства) используются конечные автоматы (ConversationHandler)

3. **Валидация данных** - все пользовательские данные проходят валидацию перед сохранением:
   - Проверка формата даты (YYYY-MM-DD)
   - Проверка числовых значений (дозировка, количество приемов)
   - Проверка единиц измерения (days/months)
   - Проверка знака зодиака

4. **Обработка ошибок** - реализована система логирования и обработки исключений для обеспечения стабильной работы

5. **Расчет статуса лекарств** - бот автоматически определяет текущий статус лекарства:
   - Активно (идет прием)
   - Перерыв (между курсами)
   - Завершено (все курсы пройдены)

6. **Умный расчет времени приема** - алгоритм распределяет приемы лекарств равномерно в течение дня

## Запуск проекта

### Требования

- Python 3.7+
- Установленные зависимости из requirements.txt

### Установка и запуск

1. Клонировать репозиторий
2. Установить зависимости: `pip install -r requirements.txt`
3. Создать файл `.env` с переменными окружения:
   ```
   TELEGRAM_BOT_TOKEN=ваш_токен_бота
   OPENWEATHER_API_KEY=ваш_ключ_api
   ```
4. Запустить бота: `python main.py`

### Docker

Проект также может быть запущен в Docker-контейнере:
```
docker-compose up -d
```

## Тестирование

Проект полностью покрыт модульными и интеграционными тестами с использованием pytest. Тесты разделены на категории:
- Модульные тесты (unit) - для тестирования отдельных функций и классов
- Интеграционные тесты (integration) - для тестирования взаимодействия компонентов
- Тесты обработчиков (handlers) - для тестирования обработчиков команд

### Структура тестов

1. **Модульные тесты**
   - `test_database.py` - тесты для работы с базой данных
   - `test_helpers.py` - тесты вспомогательных функций
   - `test_logger.py` - тесты системы логирования
   - `test_models.py` - тесты моделей данных
   - `test_notification_service.py` - тесты сервиса уведомлений
   - `test_scheduler_service.py` - тесты планировщика задач
   - `test_services.py` - тесты внешних сервисов (погода, курсы валют, гороскоп)
   - `test_validators.py` - тесты функций валидации

2. **Интеграционные тесты**
   - `test_notification_service.py` - интеграционные тесты сервиса уведомлений
   - `test_scheduler_service.py` - интеграционные тесты планировщика задач

3. **Тесты обработчиков**
   - `test_medication_handlers.py` - тесты обработчиков команд для управления лекарствами
   - `test_medication_handlers_additional.py` - дополнительные тесты обработчиков лекарств
   - `test_notification_handlers.py` - тесты обработчиков команд для управления уведомлениями

### Покрытие кода

Проект имеет 100% покрытие тестами, что обеспечивает высокую надежность и стабильность работы. Для каждого модуля реализованы тесты, проверяющие:
- Корректность работы в штатных ситуациях
- Обработку граничных случаев
- Обработку ошибок и исключений
- Взаимодействие с внешними сервисами (с использованием моков)

### Запуск тестов

Для запуска всех тестов используйте команду:
```
pytest
```

Для запуска тестов с отчетом о покрытии:
```
pytest --cov=src
```

Для генерации HTML-отчета о покрытии:
```
pytest --cov=src --cov-report=html
```

## Детальное описание модулей

### Модели данных

1. **Medication** - модель для представления данных о лекарствах:
   - Хранит все параметры лекарства (название, дозировка, расписание и т.д.)
   - Предоставляет методы для преобразования в словарь и обратно
   - Содержит методы для расчета оставшихся дней приема и даты следующего курса

2. **User** - модель для представления данных о пользователях:
   - Хранит идентификатор пользователя и знак зодиака
   - Предоставляет методы для преобразования в словарь и обратно

### Сервисы

1. **NotificationService** - сервис для отправки уведомлений:
   - Настраивает ежедневные уведомления для всех пользователей
   - Отправляет ежедневные сводки с погодой, курсами валют, гороскопом и цитатой
   - Отправляет напоминания о приеме лекарств
   - Отправляет список лекарств по запросу пользователя

2. **SchedulerService** - сервис для планирования задач:
   - Настраивает регулярные проверки необходимости отправки напоминаний
   - Проверяет статус лекарств и отправляет напоминания в нужное время
   - Учитывает дату начала, длительность курса и перерывы между курсами

3. **Services** - сервисы для работы с внешними API:
   - Получает прогноз погоды для указанных городов
   - Получает текущие курсы валют и криптовалют
   - Получает гороскоп для указанного знака зодиака
   - Предоставляет мотивационные цитаты

### Обработчики команд

1. **MedicationHandlers** - обработчики команд для управления лекарствами:
   - Обрабатывает команду /start и настройку знака зодиака при первом запуске
   - Реализует многошаговый диалог для добавления лекарства
   - Предоставляет функционал для просмотра, редактирования и удаления лекарств

2. **NotificationHandlers** - обработчики команд для управления уведомлениями:
   - Позволяет пользователю установить или изменить знак зодиака
   - Управляет настройками уведомлений (включение/выключение)
   - Позволяет установить время получения ежедневных сводок

### Утилиты

1. **helpers.py** - вспомогательные функции:
   - Рассчитывает время следующего уведомления о приеме лекарства
   - Форматирует информацию о лекарстве для отображения пользователю

2. **validators.py** - функции для валидации данных:
   - Проверяет корректность формата даты
   - Валидирует числовые значения в заданном диапазоне
   - Проверяет корректность единиц измерения
   - Валидирует знак зодиака

### База данных

**Database** - класс для работы с SQLite базой данных:
   - Создает необходимые таблицы при инициализации
   - Предоставляет методы для добавления, получения, обновления и удаления данных
   - Обеспечивает валидацию данных перед сохранением
   - Обрабатывает ошибки базы данных и предоставляет информативные сообщения

## Заключение

Not_bot - это полнофункциональный Telegram-бот для отслеживания приема лекарств, который помогает пользователям не забывать о приеме препаратов и получать полезную ежедневную информацию. Бот имеет модульную архитектуру, что облегчает его поддержку и расширение функциональности. Полное покрытие тестами обеспечивает высокую надежность и стабильность работы.
