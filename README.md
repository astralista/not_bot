# Medication Reminder Bot

Telegram бот для отслеживания приема лекарств с напоминаниями.

## Описание проекта

Medication Reminder Bot - это Telegram бот, разработанный для помощи пользователям в отслеживании приема лекарств. Бот позволяет добавлять информацию о лекарствах, настраивать расписание приема и получать своевременные напоминания. Кроме того, бот предоставляет ежедневные уведомления с полезной информацией, такой как погода, курсы валют, гороскоп и мотивационная цитата.

## Архитектура проекта

Проект имеет модульную архитектуру, разделенную на несколько основных компонентов:

### Структура проекта

```
Not_bot/
├── data/                  # Директория для хранения данных (SQLite база данных)
├── src/                   # Исходный код проекта
│   ├── bot/               # Компоненты Telegram бота
│   │   ├── handlers/      # Обработчики команд пользователя
│   │   ├── models/        # Модели данных
│   │   └── services/      # Сервисы для уведомлений и планирования
│   ├── core/              # Базовые компоненты
│   │   ├── database.py    # Работа с базой данных
│   │   └── logger.py      # Настройка логирования
│   └── utils/             # Вспомогательные функции и утилиты
├── tests/                 # Тесты
│   ├── unit/              # Модульные тесты
│   ├── integration/       # Интеграционные тесты
│   └── handlers/          # Тесты обработчиков
├── main.py                # Точка входа в приложение
├── requirements.txt       # Зависимости проекта
└── docker-compose.yml     # Конфигурация Docker Compose
```

### Компоненты системы

1. **Ядро (Core)**
   - **Database**: Класс для работы с SQLite базой данных, обеспечивающий CRUD операции для лекарств и настроек пользователя.
   - **Logger**: Настройка логирования для отслеживания работы приложения.

2. **Модели (Models)**
   - **Medication**: Модель для представления информации о лекарстве (название, дозировка, расписание приема и т.д.).
   - **User**: Модель для хранения информации о пользователе (ID, знак зодиака).

3. **Обработчики (Handlers)**
   - **MedicationHandlers**: Обработчики команд для управления лекарствами (добавление, редактирование, удаление, просмотр).
   - **NotificationHandlers**: Обработчики команд для управления уведомлениями и настройками пользователя.

4. **Сервисы (Services)**
   - **NotificationService**: Сервис для отправки ежедневных уведомлений с информацией о погоде, курсах валют, гороскопе и мотивационной цитате.
   - **SchedulerService**: Сервис для проверки расписания приема лекарств и отправки напоминаний.

5. **Утилиты (Utils)**
   - **Helpers**: Вспомогательные функции для расчета времени уведомлений и форматирования информации о лекарствах.
   - **Validators**: Функции для валидации ввода пользователя (даты, числа, единицы измерения, знаки зодиака).
   - **Services**: Класс для получения внешних данных (погода, курсы валют, гороскоп, цитаты).

### Взаимодействие компонентов

1. Пользователь взаимодействует с ботом через Telegram, отправляя команды.
2. Обработчики команд (Handlers) обрабатывают ввод пользователя и вызывают соответствующие методы базы данных.
3. База данных (Database) сохраняет информацию о лекарствах и настройках пользователя.
4. Сервисы (Services) работают в фоновом режиме, проверяя расписание приема лекарств и отправляя напоминания.
5. Утилиты (Utils) предоставляют вспомогательные функции для работы других компонентов.

## Функциональность

### Управление лекарствами

1. **Добавление лекарства**
   - Пользователь может добавить новое лекарство, указав:
     - Название лекарства
     - Дозировку (количество капсул/таблеток за один прием)
     - Количество приемов в день
     - Дату начала приема
     - Длительность курса (в днях или месяцах)
     - Длительность перерыва между курсами (в днях или месяцах)
     - Количество курсов

2. **Просмотр списка лекарств**
   - Пользователь может просмотреть список всех добавленных лекарств с информацией о:
     - Названии лекарства
     - Дозировке и количестве приемов в день
     - Дате начала приема
     - Оставшемся времени до конца курса или дате следующего курса

3. **Редактирование лекарства**
   - Пользователь может изменить любые параметры добавленного лекарства

4. **Удаление лекарства**
   - Пользователь может удалить лекарство из списка

### Уведомления

1. **Напоминания о приеме лекарств**
   - Бот отправляет напоминания о приеме лекарств в соответствии с расписанием
   - Напоминания включают название лекарства и дозировку

2. **Ежедневные уведомления**
   - Бот отправляет ежедневные уведомления в 8:00 утра, содержащие:
     - Прогноз погоды
     - Курсы валют
     - Гороскоп (в соответствии со знаком зодиака пользователя)
     - Мотивационную цитату

3. **Настройка уведомлений**
   - Пользователь может включать/выключать уведомления
   - Пользователь может изменить время ежедневных уведомлений
   - Пользователь может изменить свой знак зодиака для получения соответствующего гороскопа

## Технические детали

### Используемые технологии

- **Python**: Основной язык программирования
- **python-telegram-bot**: Библиотека для работы с Telegram Bot API
- **APScheduler**: Библиотека для планирования задач
- **SQLite**: Легковесная база данных для хранения информации о лекарствах и пользователях
- **Requests**: Библиотека для выполнения HTTP-запросов к внешним API
- **BeautifulSoup**: Библиотека для парсинга HTML (используется для получения гороскопов)
- **Docker**: Контейнеризация приложения для упрощения развертывания

### База данных

Проект использует SQLite для хранения данных. База данных содержит две основные таблицы:

1. **medications**: Хранит информацию о лекарствах
   - id: Уникальный идентификатор лекарства
   - user_id: ID пользователя Telegram
   - name: Название лекарства
   - dose_per_intake: Дозировка за один прием
   - intakes_per_day: Количество приемов в день
   - start_date: Дата начала приема
   - duration_value: Значение длительности курса
   - duration_unit: Единица измерения длительности курса (дни или месяцы)
   - break_value: Значение длительности перерыва
   - break_unit: Единица измерения длительности перерыва (дни или месяцы)
   - cycles: Количество курсов

2. **user_settings**: Хранит настройки пользователя
   - user_id: ID пользователя Telegram
   - zodiac_sign: Знак зодиака пользователя

### Планировщик задач

Проект использует APScheduler для планирования и выполнения задач:

1. **Проверка лекарств**: Каждые 30 минут проверяется, нужно ли отправить напоминание о приеме лекарства
2. **Ежедневные уведомления**: Каждый день в 8:00 утра отправляются уведомления с погодой, курсами валют, гороскопом и цитатой

## Требования

- Docker Desktop для Windows
- Git (опционально)

## Запуск бота на Windows

### Подготовка

1. Установите [Docker Desktop для Windows](https://www.docker.com/products/docker-desktop/)
2. Убедитесь, что Docker Desktop запущен и работает

### Настройка

1. Клонируйте репозиторий или скачайте исходный код
2. Создайте файл `.env` в корневой директории проекта со следующим содержимым:
   ```
   TELEGRAM_BOT_TOKEN=ваш_токен_бота
   TZ=Europe/Moscow
   OpenWeatherAPI=ваш_api_ключ_openweather
   ```
   Замените `ваш_токен_бота` на токен, полученный от @BotFather в Telegram
   Замените `ваш_api_ключ_openweather` на ключ API от OpenWeather (опционально)

3. Убедитесь, что в проекте есть директория `data` (она будет создана автоматически при сборке)

### Запуск с помощью Docker Compose

1. Откройте командную строку (PowerShell или CMD) в директории проекта
2. Выполните команду для сборки и запуска контейнера:
   ```
   docker-compose up --build
   ```
3. Для запуска в фоновом режиме используйте:
   ```
   docker-compose up --build -d
   ```
4. Для остановки контейнера выполните:
   ```
   docker-compose down
   ```

### Проверка работы

После запуска контейнера найдите своего бота в Telegram и отправьте ему команду `/start`.

## Тестирование

Проект включает полный набор тестов для обеспечения 100% покрытия кода:

### Структура тестов

- **Модульные тесты**: Тестируют отдельные компоненты системы (модели, валидаторы, вспомогательные функции)
- **Интеграционные тесты**: Тестируют взаимодействие между компонентами (сервисы уведомлений и планирования)
- **Тесты обработчиков**: Тестируют обработку команд пользователя

### Запуск тестов

1. Установите зависимости для тестирования:
   ```
   pip install -r requirements.txt
   ```

2. Запустите тесты с помощью pytest:
   ```
   pytest
   ```

3. Для просмотра отчета о покрытии кода:
   ```
   pytest --cov=src
   ```

4. Для генерации HTML-отчета о покрытии:
   ```
   pytest --cov=src --cov-report=html
   ```
   После выполнения команды отчет будет доступен в директории `htmlcov`.

## Возможные проблемы и их решение

### Проблемы с доступом к файлам

Если возникают проблемы с доступом к файлам в томе (volume), проверьте права доступа к директории `data` и убедитесь, что Docker имеет разрешение на доступ к этой директории.

### Проблемы с сетью

Если бот не может подключиться к API Telegram, убедитесь, что ваш брандмауэр не блокирует исходящие соединения Docker.

### Проблемы с Docker на Windows

Если у вас возникают проблемы с Docker на Windows:
1. Убедитесь, что WSL 2 (Windows Subsystem for Linux) установлен и настроен
2. Перезапустите Docker Desktop
3. В настройках Docker Desktop проверьте, что используется WSL 2 backend

## Возможные улучшения

1. **Добавление веб-интерфейса** для управления лекарствами и настройками
2. **Интеграция с другими мессенджерами** (WhatsApp, Viber, и т.д.)
3. **Расширение функциональности напоминаний** (добавление возможности отмечать прием лекарства, отслеживание пропущенных приемов)
4. **Добавление статистики** по приему лекарств
5. **Интеграция с медицинскими API** для получения информации о лекарствах и их взаимодействии
6. **Многоязычная поддержка** для использования бота в разных странах
